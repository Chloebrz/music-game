<!DOCTYPE html>
<html class ="ui-mobile">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<link rel="stylesheet" type="text/css" href="../style/master.css">

	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
</head>
<body >
<div data-role="page" data-theme="a" class="type-home">

	  <div data-role="header"  data-position="fixed">
		<h1>Music Puzzle</h1>
	  </div>

	<div data-role="main" >

	<div class="ui-grid-b">
		<div class="ui-block-a" id="leftSecond">
	      	<h3>PlayList<h3>
			<ul data-role="listview" id="sortable"></ul>
      	</div>
      	<div class="ui-block-b" id="mainColumn">
      		<div class="control" data-role="controlgroup" data-type="horizontal">
				<a id="playBtn" class="ui-btn ui-btn-icon-left ui-icon-play">play</a>
				<a id="pauseBtn" class="ui-btn ui-btn-icon-left ui-icon-pause">pause</a>
				<a id="nextBtn" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-next">next</a><br>

				<input id="volume" type="range" name="slider-1" id="slider-1" value="60" min="0" max="100" data-mini = "true" data-highlight="true">
      		</div>
			<div class="bgimg">
				<div class="textZone">
					<h1>Dangerous</h1>
					<h3>Michael Joseph Jackson</h3>
					<p>Dangerous is the eighth studio album by American recording artist Michael Jackson. It is his fourth studio album released through Epic Records. It was released on November 26, 1991. His first album under his new contract with Sony Music, it was also Jackson's first album since 1975's Forever, Michael not to be produced by longtime collaborator Quincy Jones, who had agreed to split after the final recording sessions for Jackson's 1987 album, Bad. Dangerous has sold 32 million copies worldwide, 7 million albums were shipped in the United States alone, and has been cited as one of the best-selling albums of all time. The album produced four top ten singles on the Billboard Hot 100 including one number-one. Similar to the musician's previous material, the album's music features elements of R&B, pop and rock while also incorporating a newer genre, new jack swing, after the inclusion of producer Teddy Riley to the project in a bid to present Jackson to a younger urban audience.</p>
				</div>
			</div>
      	</div>
      	<div class="ui-block-c" id="rightSecond">
			<h3>Joueurs<h3>
			<ul id="players-score" class="ui-listview"></ul>

			<h3>Titres recommandés<h3>
			<ul data-role="listview">
				<li><a href="#">
				<img src="../images/master/blues.jpg">
				<h2>who I am</h2>
				<p>Beatles</p></a></li>

				<li><a href="#">
				<img src="../images/master/pop.png">
				<h2>Pop music name</h2>
				<p>I love this music...</p></a></li>
			</ul>
      	</div>
	</div>

	</div>
</div>

<div data-role="popup" id="dialog-confirm">
	<div data-role="header">
		<h2><span id="name">XX</span> a buzzé !</h2>
	</div>
	<div role="main" class="ui-content">
		<p>Est-ce la bonne réponse ?</p>
		<button id="yes">Oui</button>
		<button id="no">Non</button>
	</div>
</div>

<script>
	var socket = io();

	$(function() {
		$("#sortable").sortable();

		var query_all = "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>" +
			"PREFIX blindtest:   <http://localhost:3030/blindtest/data#> " +
			"PREFIX rdfs:       <http://www.w3.org/2000/01/rdf-schema#>" +
			"PREFIX dbpedia-owl: <http://dbpedia.org/ontology/>" +
			"PREFIX dbp:        <http://dbpedia.org/property/>" +
			"PREFIX prop-fr:        <http://fr.dbpedia.org/property/>" +
			"PREFIX foaf: <http://xmlns.com/foaf/0.1/>" +
			"SELECT * WHERE { " +
			"SERVICE <http://localhost:3030/blindtest/sparql> {" +
			"?subject blindtest:hasArtist ?artist_blindtest. " +
			"?subject blindtest:hasName ?title." +
			"?subject blindtest:hasImage ?image." +
			"?subject blindtest:hasFile ?file .}}" ;

		$.post("http://localhost:3030/blindtest/query", {query: query_all}, function (data, status) {
			renderPlayList(data);
		});
	});

	function playMusic() {
		var url = $("ul#sortable li:first").attr("url");
		$.get("http://localhost:8000/audio/playMusic?musicurl=" + url, function (data, status) {
			console.log(data, status);
		});
	}

	$("#playBtn").click(function () {
		playMusic();
	});

	$("#pauseBtn").click(function () {
		$.get("http://localhost:8000/audio/pauseMusic", function (data, status) {
			console.log(data, status);
		});
	});

	$("#nextBtn").click(function () {

		$("#sortable li:last").after($("#sortable li:eq(0)"));
		playMusic();
	});

	$("#volumeBtn").click(function () {

		var value = 80;
		$.get("http://localhost:8000/audio/setVolume?value=" + value, function (data, status) {
			console.log(data, status);
		});
	});

	function renderPlayersScores (data) {

		var players = data.reduce(function (res, player) {
			return res + "<li class='ui-li-player'>" + player.pseudo + "<span class='ui-li-count'>" + player.score + "</span></li>";
		}, "");
		$("#players-score").html(players);
	}

	function renderPlayList (data) {

		var musics = data.results.bindings.reduce(function (res, music) {
			return res + "<li url=" + music.file.value + "><a href='#'><img src='" + music.image.value + "'><h2>" + music.title.value + "</h2><p>" + music.artist_blindtest.value + "</p></a></li>";
		}, "");
		$("#sortable").html(musics).listview("refresh");
	}

	socket.on("connect", function () {

		socket.emit("gameOn");

		socket.on("init", function (data) {
			renderPlayersScores(data);
		});

		socket.on("buzz", function (data) {

			$("#name").html(data);

			// $("#dialog-confirm").popup("open");
			//
			// $("#yes").click(function () {
			// 	$("#dialog-confirm").popup("close");
			// 	socket.emit("score", data);
			// });
			// $("#no").click(function () {
			// 	$("#dialog-confirm").popup("close");
			// });
		});

		socket.on("update", function (data) {
			renderPlayersScores(data);
		});
	});
</script>

</body>
</html>
